import telebot
import random
import os
from flask import Flask
from threading import Thread
import time

# Flask —Å–µ—Ä–≤–µ—Ä –¥–ª—è Render
app = Flask('')

@app.route('/')
def home():
    return "–ë–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç!"

def run():
    app.run(host='0.0.0.0', port=8080)

def keep_alive():
    t = Thread(target=run)
    t.start()

# –¢–æ–∫–µ–Ω –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
TOKEN = os.environ.get('BOT_TOKEN')
bot = telebot.TeleBot(TOKEN)

# –°–ø–∏—Å–æ–∫ —á–µ–ª–ª–µ–Ω–¥–∂–µ–π
challenges = [
    " –ù–µ –µ—Å—Ç—å —Å–ª–∞–¥–∫–æ–µ 3 –¥–Ω—è",
    " –ü–æ—Å–ª—É—à–∞–π –ø–æ–¥–∫–∞—Å—Ç –Ω–∞ —Ç–µ–º—É, –∫–æ—Ç–æ—Ä—É—é –æ–±—ã—á–Ω–æ –ª–∏—Å—Ç–∞–µ—à—å",
    " –ü–æ–ø—Ä–æ–±—É–π –Ω–æ–≤—ã–π –≤–∫—É—Å –∫–æ—Ñ–µ/—á–∞—è, –∫–æ—Ç–æ—Ä—ã–π –æ–±—ã—á–Ω–æ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—à—å",
    " –í—ã–π—Ç–∏ –Ω–∞ —É–ª–∏—Ü—É, –Ω–∞–π—Ç–∏ –∫—Ä–∞—Å–∏–≤–æ–µ –º–µ—Å—Ç–æ, –∑–∞–º–µ—Ä–µ—Ç—å –∏ —Å—Ç–æ—è—Ç—å 5 –º–∏–Ω—É—Ç, —Ä–∞–∑–≥–ª—è–¥—ã–≤–∞—è –¥–µ—Ç–∞–ª–∏ –≤–æ–∫—Ä—É–≥ (–∫–∞–∫ —Å—Ç–∞—Ç—É—è). –û—â—É—â–µ–Ω–∏—è —Å—Ç—Ä–∞–Ω–Ω—ã–µ",
    " –ö–∞–∂–¥–æ–µ —É—Ç—Ä–æ, –∫–∞–∫ —Ç–æ–ª—å–∫–æ –≤—Å—Ç–∞–ª, –¥–µ–ª–∞—Ç—å 5 –æ—Ç–∂–∏–º–∞–Ω–∏–π –∏ 10 –ø—Ä–∏—Å–µ–¥–∞–Ω–∏–π. –í—Å–µ–≥–æ 1 –º–∏–Ω—É—Ç–∞, –Ω–æ –¥–∏—Å—Ü–∏–ø–ª–∏–Ω–∏—Ä—É–µ—Ç –∂–µ—Å—Ç–∫–æ",
    " –ù–µ –≥–æ–≤–æ—Ä–∏—Ç—å –ø–µ—Ä–≤—ã–º, –ø–æ–∫–∞ –∫ —Ç–µ–±–µ –Ω–µ –æ–±—Ä–∞—Ç—è—Ç—Å—è (–∫—Ä–æ–º–µ —Ä–∞–±–æ—Ç—ã/—É—á–µ–±—ã). –ü—Ä–æ—Å—Ç–æ –Ω–∞–±–ª—é–¥–∞–π",
    " –•–æ–¥–∏—Ç—å –ø–æ –∫–≤–∞—Ä—Ç–∏—Ä–µ –∑–∞–¥–æ–º, –µ—Å—Ç—å –¥–µ—Å–µ—Ä—Ç –ø–µ—Ä–µ–¥ —Å—É–ø–æ–º, —á–∏—Å—Ç–∏—Ç—å –∑—É–±—ã –¥—Ä—É–≥–æ–π —Ä—É–∫–æ–π, —á–∏—Ç–∞—Ç—å –∫–Ω–∏–≥—É —Å –∫–æ–Ω—Ü–∞. –í—Å—Ç—Ä—è—Ö–Ω—É—Ç—å –º–æ–∑–≥",
    " –î–µ–ª–∞—Ç—å –≤—Å–µ –æ—Å–Ω–æ–≤–Ω–æ–π —Ä—É–∫–æ–π, –∫–æ—Ç–æ—Ä–æ–π –Ω–µ –ø–æ–ª—å–∑—É–µ—à—å—Å—è: –ø–∏—Å–∞—Ç—å, –µ—Å—Ç—å, —á–∏—Å—Ç–∏—Ç—å –∑—É–±—ã, –ª–∏—Å—Ç–∞—Ç—å –ª–µ–Ω—Ç—É. –ë–µ—Å–∏—Ç –∂—É—Ç–∫–æ, –Ω–æ –º–æ–∑–≥ –∫–∞—á–∞–µ—Ç",
    " –°–µ—Å—Ç—å –∏ –Ω–∞–ø–∏—Å–∞—Ç—å 100 –∏–¥–µ–π –Ω–∞ –ª—é–±—É—é —Ç–µ–º—É (—á—Ç–æ –ø–æ–¥–∞—Ä–∏—Ç—å –º–∞–º–µ, –∫–∞–∫ –∑–∞—Ä–∞–±–æ—Ç–∞—Ç—å –º–∏–ª–ª–∏–æ–Ω, –∫—É–¥–∞ –ø–æ–µ—Ö–∞—Ç—å). –ë—Ä–µ–¥–æ–≤—ã–µ ‚Äî –º–æ–∂–Ω–æ, –≥–ª–∞–≤–Ω–æ–µ ‚Äî –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ",
    " –ü–æ–∑–≤–æ–Ω–∏—Ç—å —Å—Ç–∞—Ä–æ–º—É –¥—Ä—É–≥—É",
    " –ü–æ–∑–≤–æ–Ω–∏ —Ä–æ–¥–∏—Ç–µ–ª—è–º –∏–ª–∏ –±–∞–±—É—à–∫–µ, –∞ –Ω–µ –ø–∏—à–∏ –≤ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä",
    " –ù–∞–ø–∏—à–∏ —Å—Ç–∞—Ä–æ–º—É –¥—Ä—É–≥—É –ø—Ä–æ—Å—Ç–æ —Ç–∞–∫, —Å–ø—Ä–æ—Å–∏ –∫–∞–∫ –¥–µ–ª–∞",
    " –°–¥–µ–ª–∞—Ç—å –∑–∞—Ä—è–¥–∫—É 7 –¥–Ω–µ–π –ø–æ–¥—Ä—è–¥",
    " –ù–µ —Å–∏–¥–µ—Ç—å –≤ —Å–æ—Ü—Å–µ—Ç—è—Ö –ø–æ—Å–ª–µ 22:00",
    " –°–¥–µ–ª–∞–π —Ç—Ä–∏ —Ñ–æ—Ç–æ –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω —Å –Ω–µ–æ–±—ã—á–Ω–æ–≥–æ —Ä–∞–∫—É—Ä—Å–∞ (—Å –∑–µ–º–ª–∏, —Å–≤–µ—Ä—Ö—É)",
    " –ü—Ä–æ–π—Ç–∏ 10 000 —à–∞–≥–æ–≤",
    " –ù–∞—á–∞—Ç—å –∫–æ–ø–∏—Ç—å –¥–µ–Ω—å–≥–∏",
    " –ù–æ—Å–∏ –æ–¥–Ω—É –ª—é–±–∏–º—É—é –≤–µ—â—å —Ü–µ–ª—ã–π –¥–µ–Ω—å (–¥–∞–∂–µ –µ—Å–ª–∏ –Ω–µ–∫—É–¥–∞)",
    " –°–¥–µ–ª–∞—Ç—å –ø–æ–¥–∞—Ä–æ–∫ —Å–µ–±–µ",
    " –ü—Ä–∏–≥–æ—Ç–æ–≤–∏—Ç—å –Ω–æ–≤–æ–µ –±–ª—é–¥–æ",
    " –ù–∞–ø–∏—Å–∞—Ç—å —Å–ø–∏—Å–æ–∫ —Ü–µ–ª–µ–π –Ω–∞ –º–µ—Å—è—Ü",
    " –ù–∞—Ä–∏—Å–æ–≤–∞—Ç—å —á—Ç–æ-–Ω–∏–±—É–¥—å",
    " –í—ã—É—á–∏—Ç—å 10 –∏–Ω–æ—Å—Ç—Ä–∞–Ω–Ω—ã—Ö —Å–ª–æ–≤",
    " –£–±—Ä–∞—Ç—å—Å—è –≤ –∫–æ–º–Ω–∞—Ç–µ",
    " –†–∞–∑–±–µ—Ä–∏ –æ–¥–∏–Ω —è—â–∏–∫/–ø–æ–ª–∫—É, –∫–æ—Ç–æ—Ä—É—é –¥–∞–≤–Ω–æ –æ—Ç–∫–ª–∞–¥—ã–≤–∞–ª",
    " –ü–æ–º–∏—Ä–∏—Ç—å—Å—è —Å —Ç–µ–º, —Å –∫–µ–º –≤ —Å—Å–æ—Ä–µ",
    " –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ñ–∏–ª—å–º –Ω–∞ –∏–Ω–æ—Å—Ç—Ä–∞–Ω–Ω–æ–º —è–∑—ã–∫–µ",
    " –ù–∞–ø–∏—Å–∞—Ç—å –ø–∏—Å—å–º–æ —Å–µ–±–µ –≤ –±—É–¥—É—â–µ–µ",
    " –ü–æ–∫–∞—Ç–∞—Ç—å—Å—è –Ω–∞ –≤–µ–ª–æ—Å–∏–ø–µ–¥–µ",
    " –ü—Ä–æ–±–µ–≥–∏ 1 –∫–º —Ö–æ—Ç—å –∫–∞–∫-—Ç–æ, —Ö–æ—Ç—å –º–µ–¥–ª–µ–Ω–Ω–æ, –ø—Ä–æ—Å—Ç–æ –Ω–µ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–π—Å—è"
]

# –•—Ä–∞–Ω–∏–ª–∏—â–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
user_data = {}

@bot.message_handler(commands=['start'])
def start(message):
    bot.send_message(
        message.chat.id,
        "üî• –ü—Ä–∏–≤–µ—Ç! –Ø –±–æ—Ç-—á–µ–ª–ª–µ–Ω–¥–∂–µ–π!\n\n"
        "/challenge - –ø–æ–ª—É—á–∏—Ç—å —á–µ–ª–ª–µ–Ω–¥–∂\n"
        "/next - –∑–∞–º–µ–Ω–∏—Ç—å (–µ—Å–ª–∏ –Ω–µ –Ω—Ä–∞–≤–∏—Ç—Å—è)\n"
        "/done - –æ—Ç–º–µ—Ç–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ\n"
        "/stats - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞"
    )

@bot.message_handler(commands=['challenge'])
def get_challenge(message):
    user_id = message.from_user.id
    challenge = random.choice(challenges)
    
    if user_id not in user_data:
        user_data[user_id] = {'current': challenge, 'completed': []}
    else:
        user_data[user_id]['current'] = challenge
    
    bot.send_message(
        message.chat.id,
        f"üéØ –¢–≤–æ–π —á–µ–ª–ª–µ–Ω–¥–∂:\n\n{challenge}\n\n"
        f"–ù–µ –Ω—Ä–∞–≤–∏—Ç—Å—è? –ù–∞–∂–º–∏ /next"
        f"–ö–æ–≥–¥–∞ –≤—ã–ø–æ–ª–Ω–∏—à—å - –Ω–∞–∂–º–∏ /done"
    )

@bot.message_handler(commands=['next'])
def next_challenge(message):
    user_id = message.from_user.id
    
    if user_id in user_data and user_data[user_id].get('current'):
        current = user_data[user_id]['current']
        available = [c for c in challenges if c != current]
        new = random.choice(available)
        user_data[user_id]['current'] = new
        
        bot.send_message(
            message.chat.id,
            f"üîÑ –ó–∞–º–µ–Ω–∏–ª –Ω–∞:\n\n{new}"
        )
    else:
        bot.send_message(
            message.chat.id,
            "‚ùå –°–Ω–∞—á–∞–ª–∞ –ø–æ–ª—É—á–∏ —á–µ–ª–ª–µ–Ω–¥–∂ —á–µ—Ä–µ–∑ /challenge"
        )

@bot.message_handler(commands=['done'])
def mark_done(message):
    user_id = message.from_user.id
    
    if user_id in user_data and user_data[user_id].get('current'):
        challenge = user_data[user_id]['current']
        user_data[user_id]['completed'].append(challenge)
        user_data[user_id]['current'] = None
        
        count = len(user_data[user_id]['completed'])
        bot.send_message(
            message.chat.id,
            f"‚úÖ –ú–æ–ª–æ–¥–µ—Ü! –í—ã–ø–æ–ª–Ω–µ–Ω–æ —á–µ–ª–ª–µ–Ω–¥–∂–µ–π: {count}"
        )
    else:
        bot.send_message(
            message.chat.id,
            "‚ùå –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —á–µ–ª–ª–µ–Ω–¥–∂–∞. –ù–∞–∂–º–∏ /challenge"
        )

@bot.message_handler(commands=['stats'])
def stats(message):
    user_id = message.from_user.id
    
    if user_id in user_data and user_data[user_id]['completed']:
        count = len(user_data[user_id]['completed'])
        last = user_data[user_id]['completed'][-5:]
        last_text = "\n".join([f"‚úÖ {c}" for c in last])
        
        bot.send_message(
            message.chat.id,
            f"üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:\n"
            f"–í—Å–µ–≥–æ: {count}\n\n"
            f"–ü–æ—Å–ª–µ–¥–Ω–∏–µ:\n{last_text}"
        )
    else:
        bot.send_message(
            message.chat.id,
            "üìä –ü–æ–∫–∞ –Ω–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö —á–µ–ª–ª–µ–Ω–¥–∂–µ–π"
        )

# –ó–∞–ø—É—Å–∫–∞–µ–º Flask –≤ —Ñ–æ–Ω–µ
keep_alive()

# –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞
print("‚úÖ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω! –°–µ—Ä–≤–µ—Ä Flask —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –ø–æ—Ä—Ç—É 8080")
bot.infinity_polling()